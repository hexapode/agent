<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agent Demo</title>
    
    <style>
      #MainView {
        display: block;
      }
      #FlowView {
        display: none;
      }

      .task {
        padding: 8px;
        border : 1px solid #eee;
      }
    </style>

    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
            
</head>
<body>
  <nav class="blue-grey darken-4" role="navigation">
    <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">Presonal Agent</a>
      <!-- <ul class="right hide-on-med-and-down">
        <li><a href="#">Navbar Link</a></li>
      </ul>

      <ul id="nav-mobile" class="sidenav">
        <li><a href="#">Navbar Link</a></li>
      </ul>
    -->
      <a href="#" data-target="nav-mobile" class="sidenav-trigger"><i class="material-icons">menu</i></a>
    </div>
  </nav>

  <div class="section no-pad-bot" id="index-banner">
    <div class="container">
      <div id="MainView"> 
        <input type="text" id="agent" name="agent" placeholder="Agent Goal..." value="For each country of the world identify their main legislation and where it can be access online (url). If the country have a federal organization, also identify each of the regulation of each state like administration.">
        <button id="btn" class="btn-large waves-effect waves-light" onclick="start()">Start</button>
      </div>
    
      <div id="FlowView"> 
        <div id="flowContent">
    
        </div>
      </div>
    </div>

  </div>

  <script>
    // get content after hashbang
    var hash = window.location.hash.substr(1);
    let agentID  = null;

    if (hash.length) {
      renderFlow(hash);
    }
    
    async function start() {
      MainView.style.display = 'none';

      let agent = document.getElementById('agent').value;
      
      // FETCH POST '/api/agent'
      let res = await fetch('/api/agent', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({goal: agent})
      });

      let data = await res.json();

      // add hashbang to urkl
      window.location.hash = data.agentID;
      renderFlow(data.agentID);
    }


    async function renderFlow(id) {
      if (id) {
        agentID = id;
      }
      let refresh = true;
      MainView.style.display = 'none';
      FlowView.style.display = 'block';
      
      let res = await fetch(`/trace/log-${agentID}.json`);
      let data = await res.json();

      let flowContent = document.getElementById('flowContent');
      flowContent.innerHTML = '';

      let taskList = {

      }

      for (let item of data) {
        let div = document.createElement('div');
        div.className = 'collection-item';

        div.innerHTML = `
          <div class='actionType'>${item.type}</div>
        `

        if (item.type === 'NEW_TASK') {
          div.innerHTML += `
            <div class='goal'>${item.goal}</div>
          `
        }
        else if (item.type === 'REASONING') {
          div.innerHTML += `
            <pre class='reasoning'>${item.answer.replace(/::/g, "Do ")}</pre>
          `
        }
        else if (item.type === 'SEARCH') {
          div.innerHTML += `
            <pre class='query'>${item.query}</pre>
            <pre class='result'>${item.result}</pre>
          `
        }
        else if (item.type === 'GET_PAGE') {
          div.innerHTML += `
            <pre class='url'>${item.query}</pre>
            <div class='result'>${item.result}</div>
          `
        }
        else if (item.type === 'ASK_CLARIFICATION') {
          div.innerHTML += `
            <div>${item.args}</div>
          `
          if (!item.parentTaskId && item == data[data.length - 1]) {
            div.innerHTML += `
            <input type='text' id='answer'>
            <input type='button' value='Send' onclick="answer('${item.taskId}')">
            `
            refresh = false;
          }
        }
        else {
          div.innerHTML += `
            <div class='JSON'><pre>${JSON.stringify(item, null, 2)}</pre></div>
          `
        }
        if (item.type == "NEW_TASK") {
          taskList[item.taskId] = div;
          div.className = 'task';

          if (item.parentTaskId) {
            taskList[item.parentTaskId].appendChild(div);
          }
          else {
            flowContent.appendChild(div);
          }
        }
        else {
          taskList[item.taskId].appendChild(div);
        }
        
      }
      if (refresh) {
        setTimeout(renderFlow, 1000);
      }
    
    }

    async function answer(taskId) {
      let answer = document.getElementById('answer').value;

      await fetch(`/api/agent/${agentID}/${taskId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({answer : answer})
      });
      renderFlow(agentID);
    }
  </script>

  <!--JavaScript at end of body for optimized loading-->
  <script type="text/javascript" src="js/materialize.min.js"></script>


</body>

</html>